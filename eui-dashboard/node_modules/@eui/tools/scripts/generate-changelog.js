'use strict';

const changelog = require('./changelog');
const fs        = require('fs');
const argv = require('minimist')(process.argv.slice(2));
const path = require('path');

var rootPath;

const pkg = argv._[0];

if (pkg) {
    rootPath = path.join(process.cwd(),'packages',pkg);
} else {
    rootPath = path.join(process.cwd());
}

console.log('Generating changelog for : ', rootPath);

return Promise.resolve()
            .then(() => {
                console.log('--generating changelog');

                return changelog.generate({ patch: false, exclude: 'chore,style', packageRootPath: rootPath })
                    .then(function (changelog) {
                        const file = path.join(rootPath,'CHANGELOG.md');

                        if (fs.existsSync(file)) {
                            const data = fs.readFileSync(file); //read existing contents into data
                            const fd = fs.openSync(file, 'w+');
                            const buffer = new Buffer(changelog);

                            fs.writeSync(fd, buffer, 0, buffer.length, 0); //write new data
                            fs.writeSync(fd, data, 0, data.length, buffer.length); //append old data
                            fs.close(fd);
                        } else {
                            fs.writeFileSync(file, changelog);
                        }
                    });
            })
            .then(() => {
                console.log('----------------------------------------------');
                console.log('changelog updated');
                console.log('----------------------------------------------');
            })
            .catch((e) => {
                console.log('ERROR !');
                console.log(e);
            });



