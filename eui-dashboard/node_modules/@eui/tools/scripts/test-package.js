'use strict';

const chalk = require('chalk');

const config = require('../config/project');
const tools = require('./tools');
const utilsPackages = require('./utils/packages');

const pkgInfo = utilsPackages.getPackage();
const { pkg } = pkgInfo;

return Promise.resolve()
    .then(() => {
        console.log('\n\n---------------------------------------------------');
        console.log(chalk.cyan('Testing package : ', `${pkgInfo.pkg}...`));
        console.log('---------------------------------------------------');
    })
    .then(() => {
        return tools.runScript(`eui-scripts clean-package ${pkg}`);
    })
    .then(() => {
        const { watch } = config;

        if (watch === true) {
            return Promise.all([
                tools.runScript(`eui-scripts build-tests ${pkg} --w`),
                tools.runScript(`eui-scripts start-karma ${pkg}`)
            ]);
        }

        return tools.runScript(`eui-scripts build-tests ${pkg}`)
            .then(() => {
                return tools.runScript(`eui-scripts start-karma ${pkg} --single-run`)
            });
    })
    .catch((e) => {
        console.log('\n---------------------------------------------------');
        console.log(chalk.red("Build ERROR. See above for errors."));
        console.log('---------------------------------------------------');
        console.error(e);
        process.exit(1);
    });
