const path = require('path');
const execa = require('execa');
const tools = require('./tools');

function run(scope, registry) {

    if (!registry) {
        console.log('ERROR : no registry specified!!!');
        return;
    }

    console.log('---------------------------------------------------------------------------');
    console.log('Publishing eui packages on ' + registry);
    console.log('---------------------------------------------------------------------------');

    const packages = tools.getPackages();

    if (packages.length === 0) {
        return;
    }

    registry = '--registry ' + registry;

    const packagesRoot = 'src/packages';

    return Promise.resolve()
            .then(() => {
                return packages.reduce((promise, item) => {
                    return promise.then(() => {
                        console.log('-- Publishing package', scope + '/' + `${item.package}`, "\n");
                        const packagePath = path.join(process.cwd(), packagesRoot, item.package);
                        return execa.shell(`npm publish ${packagePath} ${registry}`);
                    });
                }, Promise.resolve());
            })
            .then(() => {
                console.log('----------------------------------------------');
                console.log('packages published!');
                console.log('----------------------------------------------');
            })
            .catch((e) => {
                console.log('ERROR!');
                console.log(e);
            });

}

module.exports.run = run;
