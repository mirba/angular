'use strict';

const chalk = require('chalk');

const config = require('../config/project');
const tools = require('./tools');
const depGraph = require('./dependency-graph');

const args = process.argv.slice(2);

const packages = depGraph.overallOrder().filter(p => {
    const pkg = config.packages[p];
    if (!pkg) {
        return false;
    }

    if (!pkg.build) {
        return true;
    }
    return pkg.build.exec !== false;
});

if (packages.length > 0) {
    console.log('----------------------------------------------');
    console.log(chalk.cyan(`Building ALL packages (total: ${packages.length})\n[${packages}]`));
    console.log('----------------------------------------------');

    return packages.reduce((promise, pkg) => {
        const item = depGraph.getNodeData(pkg);

        return promise
            .then(() => tools.runScript(`eui-scripts build-package ${pkg} ${args.join(' ')}`));
    }, Promise.resolve())
    .catch(() => {
        process.exit(1);
    });
}
