'use strict';

const chalk = require('chalk');

const tools = require('./tools');
const utilsPackages = require('./utils/packages');
const depGraph = require('./dependency-graph');

const pkgInfo = utilsPackages.getPackage();
const { pkg } = pkgInfo;
const deps = depGraph.dependenciesOf(pkg);

if (deps.length > 0) {
    console.log('----------------------------------------------');
    console.log(chalk.cyan(`Building package dependencies of package ${pkg} (total: ${deps.length})\n[${deps}]`));

    return deps.reduce((promise, dep) => {
        const item = depGraph.getNodeData(dep);

        return promise
            .then(() => (
                tools.runScript(`eui-scripts clean-package ${dep}`)
                    .then(() => tools.runScript(`eui-scripts compile-package ${dep}`))
            ))
            .catch(() => {
                process.exit(1);
            });
    }, Promise.resolve());
}
