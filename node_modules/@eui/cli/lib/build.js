const tools = require('@eui/tools/scripts/tools');
const utils = require('./utils');
const config = require('./config');
const path = require('path');
const childProcess = require("child_process");
const execSync = childProcess.execSync;

function start(cliConfig, targetPath, callback) {
    const appType = cliConfig.appType;
    const appSubType = cliConfig.appSubType;
    const tag = cliConfig.tag;
    const groupId = cliConfig.groupId;
    const artifactId = cliConfig.artifactId

    console.log(`Building app : ${appType}-${appSubType}`);

    console.log(`--Provided config : ${JSON.stringify(cliConfig)}`);

    console.log(`--cleaning target : ${targetPath}`);

    // Cleaning up
    tools.rmdirFull(targetPath);

    // BUILD angular
    // -------------
    if (appType === 'angular') {
        console.log('---building angular');

        utils.copyAngular(targetPath, cliConfig);
    }


    // BUILD web-maven
    // ---------------

    if (appType === 'web-maven') {
        console.log('--building web-maven');

        tools.copydir(config.webMavenPath, targetPath);

        const angularPath = utils.getAngularPath(targetPath, appType);
        utils.copyAngular(angularPath, cliConfig);
    }


    // BUILD full-stack
    // ----------------

    if (appType === 'full-stack') {
        console.log('--building full-stack');

        // copy from skeleton sources
        // tools.copydir(config.fullStackPath, targetPath);

        // rename root folders, replace groupId paths, ... (TODO redo this in node scripts when have time)
        execSync(`mvn generate-sources -f ./maven-build/pom.xml -Pbuild-full-stack -Dsrc.path=${config.fullStackPath} -Dtarget.path=${targetPath} -Dapp.group.id=${groupId} -Dapp.artifact.id=${artifactId}`, {cwd: path.join(__dirname), stdio: "inherit"});

        // copy angular sources
        const angularPath = utils.getAngularPath(targetPath, appType, artifactId);
        utils.copyAngular(angularPath, cliConfig);
    }


    // BUILD web-spring-boot
    // ---------------------

    if (appType === 'web-spring-boot') {
        console.log('--building web-spring-boot');

        // rename root folders, replace groupId paths, ... (TODO redo this in node scripts when have time)
        execSync(`mvn generate-sources -f ./maven-build/pom.xml -Pbuild-web-spring-boot -Dsrc.path=${config.webSpringBootPath} -Dtarget.path=${targetPath} -Dapp.group.id=${groupId} -Dapp.artifact.id=${artifactId}`, {cwd: path.join(__dirname), stdio: "inherit"});

        // copy angular sources
        const angularPath = utils.getAngularPath(targetPath, appType, artifactId);
        utils.copyAngular(angularPath, cliConfig, false);
    }

    callback();
}


module.exports.start = start;
